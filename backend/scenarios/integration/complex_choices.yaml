metadata:
  name: "Integration - Complex Choice Trees"
  description: "End-to-end test: conditional choices based on flags, meters, inventory, time"
  game: "coffeeshop_date"
  author: "PlotPlay Team"
  tags: ["phase-4", "integration", "choices", "conditions", "branching"]

mocks:
  writer:
    intro: "You arrive at the cozy cafe, the smell of fresh coffee filling the air."
    choice1: "You make your first choice, opening new possibilities."
    choice2: "Your confidence affects the available options."
    choice3: "The situation evolves based on your previous actions."
    outcome: "The choices you made have led to this moment."

  checker:
    default:
      meters: {}
      flags: {}
      character_memories: {}
      safety:
        ok: true

    set_flag:
      flags:
        first_choice_made: true
      meters: {}
      character_memories: {}
      safety:
        ok: true

    boost_confidence:
      meters:
        player:
          confidence: 15
      flags: {}
      character_memories: {}
      safety:
        ok: true

steps:
  - name: "Start game"
    action: start
    mock_writer_key: intro
    expect:
      location: "cafe_patio"
      meters:
        player.confidence: 55

  - name: "Make first choice"
    action: say
    action_text: "Greet Alex warmly"
    mock_writer_key: choice1
    expect:
      location: "cafe_patio"

  - name: "Navigate to counter"
    action: goto
    location: "cafe_counter"
    mock_writer_key: intro
    expect:
      location: "cafe_counter"

  - name: "Make choice at counter"
    action: say
    action_text: "Order confidently"
    mock_writer_key: choice2
    expect:
      location: "cafe_counter"

  - name: "Return to patio"
    action: goto
    location: "cafe_patio"
    mock_writer_key: intro
    expect:
      location: "cafe_patio"

  - name: "Make final choice"
    action: say
    action_text: "Continue the conversation"
    mock_writer_key: choice3
    expect:
      location: "cafe_patio"

  - name: "Verify branching outcome"
    action: do
    action_text: "Reflect on the interaction"
    mock_writer_key: outcome
    expect:
      location: "cafe_patio"
